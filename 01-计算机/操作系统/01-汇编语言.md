# 0 写在前面

本笔记继续x86架构，Windows XP系统提供的实地址模式(16位系统)编写。

# 1 基础知识

## 1.1 机器语言&汇编

- duan机器指令是一列二进制数字，每一条机器指令都完整的描述了一个操作，机器语言是机器指令的集合

- 每一种微处理器，因设计的不同。从而导致机器指令的不同，因此机器语言是不能移植的

- 在同一种CPU结构下，每条机器语言指令都有对应的汇编指令，汇编语言更便于记忆

- 通过编译器，可以将汇编语言转换成机器语言

- 汇编语言的分类

  - 汇编指令：机器码助记符，由对应的机器码
  - 伪指令：由编译器执行，计算机不执行
  - 其他符号：如+、-、*、%。没有机器码，由编译器识别

  > 汇编指令是汇编语言的核心，它决定了汇编语言的特性

## 1.2 电脑硬件基础

电脑中的硬件大概有如下部分

- CPU
- 主板：利用总线连接电脑的各个部件
- 内存
- 各种接口卡
  - 显卡
  - 网卡
  - 声卡
  - 磁盘
- 电源

## 1.3 内存

- 指令和数据在内存中存放，在形式上二者没有任何区别，都是二进制信息
- 内存的最小存储单位称为**内存单元**，一个内存单元可以存储一个字节。内存的容量是以字节为最小单位来计算的
- 内存/磁盘容量的单位进制
  - 8bit = 1Byte
  - 1kb = 1024B
  - 1mb = 1024kb
  - 1gb = 1024mb
  - 1tb = 1024gb
- CPU从内存读写信息时，必须提供地址信息(内存地址)，控制信息(读/写)，数据信息(数据)。由这3中信息，可以将总线分为3类
  - 地址总线：一个CPU有N根地址线，则可以说这个CPU的地址总线宽度为N，最多可以寻找2^N个内存单元
  - 数据总线：一个CPU有N根数据线，则可以说这个CPU一次可以传输N位的数据
  - 控制总线：控制总线的宽度决定CPU对外部器件的控制能力
- 各种硬件：计算机系统中，所有可用程序控制其工作的设备，必须受到CPU的控制。
  - 主板：用来连接各个主要部件的底座
  - 接口卡：包括显卡，声卡等等。CPU通过总线向接口卡发送命令，接口卡根据命令控制外设的工作(CPU发送指令给显卡，显卡控制 显示器工作)
  - 各类存储器芯片：
    - RAM：随机存储器，存储器必须带电，关机后存储的内容丢失
    - ROM：只读存储器，关机后存储的内容不会丢失，但不能改变存储器中的内容（如BIOS）
    - 接口板RAM：有些接口卡需要大批量的数据输入，如显卡。会有一个接口板RAM来作为数据中继，如显存
- 内存地址空间：
  - 一个CPU有N根地址线，则可以说这个CPU的地址总线宽度为N，最多可以寻找2^N个内存单元。这2^N个内存单元被称为内存地址空间
  - CPU在操作内存地址空间时，会将主存，ROM，接口板RAM抽象为一个统一的线性逻辑存储器。该线性逻辑存储器的最大大小不超过内存地址空间(2^N)
  - 每个主存，接口板的内存都在线性逻辑存储器中占有一个地址段，称为一段地址空间。通过读写相应的地址段，就能控制相应的设备

# 2 寄存器

CPU的由如下器件组成

- 运算器：进行信息处理
- 寄存器：进行信息存储
- 控制器：控制各个部件之间的工作
- 内部总线：连接CPU内的各个部件

对于汇编程序员来讲，CPU中的主要部件是寄存器

## 2.1 通用寄存器

- 通用寄存器有AX，BX，CX，DX。每个寄存器可以存放2个字节

- 上述4个寄存器可以进行拆分，以AX举例：高8位为AH，低8位为AL。AH，AL每个寄存器有1个字节

- 字节：记为byte，一个字节由8bit组成，可以存放在8位寄存器中

- 字：记为word，一个字由两个字节组成，高8位组成高位字节，低8位组成低位字节

- 将4E20存放在AX中，其中 AH存放4E，AL存放4L

## 2.3 汇编指令01

```assembly
mov ax,18		;将18传递给AX寄存器
add ax,1406h	;等价于ax = ax+1406h
```

第二个操作数可以是直接数，也可以是寄存器。指令的两个对象的位数应当是一致的，即两个字数据作为操作数是合法的；一个字数据，一个字节数据的操作是非法的

## 2.4 x位结构CPU

例如16位结构(16位机，字长为16表达的都是一个意思)是指：

- 运算器一次最多可以处理16为数据
- 寄存器的最大宽度为16bit
- 寄存器和运算器之间的通路为16位

换句话说：在16位结构的cpu 内部，能够一次处理，传输，暂时存储的信息的最大长度为16bit

## 2.5 物理地址

在1.3中提到，操作系统会将所有内存单元抽象成一个线性地址空间。在这个线性地址空间中，每一个内存单元都有一个唯一的地址，这个唯一地址称为这个内存单元的物理地址
### 2.5.1 8086CPU给出物理地址的方法

8086CPU是16位结构的CPU。需要读写内存时，按照如下步骤进行：

1. CPU中的相关部件提供两个16位的地址，一个称为段地址，另一个称为偏移地址
2. 段地址和偏移地址通过内部总线送入一个称为地址加法器的部件
3. 地址加法器将两个16位地址合成一个20位的物理地址
4. 地址加法器通过内部总线将20位物理地址送入输入输出控制电路
5. 输入输出控制电路将20位物理地址送上地址总线
6. 20位物理地址被地址总线传送到传输器

**物理地址计算公式**：物理地址 = 段地址 * 16 + 偏移地址

> 一个X进制的数据左移一位，就相当于乘X

### 2.5.2 段地址+偏移地址的本质含义

以8086CPU为例，如果只用16位地址总线，能表示的地址个数为：2^16 = 65536个

如果使用20位，能表示的地址个数为：2^20 =  1,048,576个

以希望有更大的内存位为大前提。我们盼望CPU内部可以处理20位的总线。但是，16位的CPU没法直接表示20位的地址

因此，如果提前定义一个公式：16位地址*常数+偏移地址，则可以在CPU内部总线较少的情况下，来得到更大的地址空间

所以，本质上：这种计算方式是用另一种方式来扩大内存地址空间

## 2.6 段的概念

- 内存没有真正意义上的分段，这里指的分段是通过程序员人为定义的。即一个地址可以用多个`段地址 * 16 + 偏移地址`来表示
- 这种分段的方式的主要目标是方便程序员来管理内存
- 在8086CPU中，一个段的起始地址一定是16的倍数，因为段地址*16
- 因为8086是16位结构的CPU，因此偏移地址最大为FFFF，一个段的最大长度为64KB

## 2.7 段寄存器

8086CPU中，段寄存器一共有4个：CS，DS，SS，ES

### 2.7.1 指令寄存器：CS和IP

CS为代码段寄存器，IP为指令指针寄存器

设CS的内容为M，IP中的内容为N。则8086CPU将从内存M*16+N单元开始，读取一条指令并执行

- 指令执行的顺序：
  1. 从CS：IP指向的内存单元读取指令 ，读取的指令进入指令缓冲器
  2. IP = IP + 所读取的指令的长度，从而指向下一条指令
  3. 执行指令。转到步骤1，重复执行
- 8086 CPU执行的第一条指令：在CPU加电或复位后，CS指向FFFFH，IP指向0000H。即FFFF0H单元中的指令是8086CPU开机执行的第一条指令
- CPU将CS：IP指向的内存单元中的内容看作指令
- 修改CS、IP的内容：
  - 同时修改CS、IP的内容：jmp 段地址:偏移地址
  - 仅修改IP： jmp 某一合法的寄存器(如ax,bx,cx...)

### 2.7.2 内存访问：DS 和 []

前面说过，用16位寄存器来存储一个字。高8位放高位字节，低8位存放低位字节

但如果使用内存存储一个字，这个字的低位字节存放在低地址单元中，高位字节存放在高地址字节中

**子单元**：存放一个字型数据的内存单元，由两个连续的内存单元组成。高地址内存单元中存放字型数据的高位字节，低地址内存单元中存放字型数据的低位字节

**N地址字单元**：将起始地址为N的字单元简称为N地址字单元

8086CPU中有一个DS寄存器，通常来存放要访问数据的段地址，偏移地址通过[]中的数据给出

> 8086CPU 不允许将数据直接送入段寄存器，必须通过通用寄存器(ax,bx...)进行中转

### 2.7.3 栈 SS和SP





